<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Form - Hadayeq Helwan</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background: #f0f4f8;
    }
    h2 {
      color: #2b6cb0;
    }
    form {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 400px;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background-color: #2b6cb0;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background-color: #1e4f7f;
    }
    #locationStatus {
      margin-top: 10px;
      font-weight: bold;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <h2>Class Attendance Form</h2>
  <form id="attendanceForm">
    <label for="name">Name:</label>
    <input type="text" id="name" required />

    <label for="track">Track:</label>
    <select id="track" required>
      <option value="">Select</option>
      <option value="Java">Java</option>
      <option value="Mobile">Mobile</option>
    </select>

    <button type="button" onclick="checkLocation()">Submit Attendance</button>
    <div id="locationStatus"></div>
  </form>

  <script>
    const targetLatitude = 30.070993;
    const targetLongitude = 31.021402;
    const allowedRadius = 1000; // meters

    // Separate Google Apps Script Web App URLs
    const googleScriptURL_Java = "https://script.google.com/macros/s/AKfycbyPDoMlhwjgnN6QxT7hDZm0Rz4jnIbuX4vNCmd8A2TTq7OxaLmHml3IddGhX91q61my/exec";
    const googleScriptURL_Mobile = "https://script.google.com/macros/s/AKfycbweQ1SpRV-slkBk1GNJz2ItivjbK6MetBnQEHiOw6HT9hQZDVigb9diRYlt7p6ZEI5B/exec";

    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function checkLocation() {
      const status = document.getElementById("locationStatus");
      const name = document.getElementById("name").value.trim();
      const track = document.getElementById("track").value;

      if (!name || !track) {
        alert("Please fill out your name and track first.");
        return;
      }

      if (!navigator.geolocation) {
        status.textContent = "Geolocation is not supported by your browser.";
        return;
      }

      status.textContent = "Checking location...";

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const accuracy = position.coords.accuracy;
          const distance = getDistanceFromLatLonInMeters(
            targetLatitude,
            targetLongitude,
            lat,
            lon
          );

          status.innerHTML = `
            Your latitude: ${lat.toFixed(6)}<br>
            Your longitude: ${lon.toFixed(6)}<br>
            Accuracy (meters): ${accuracy.toFixed(2)} m<br>
            Distance to target: ${distance.toFixed(2)} m<br>
          `;

          if (distance <= allowedRadius) {
            status.innerHTML += "<span style='color:green;'>✅ Location verified</span>";

            const webAppURL = track === "Java" ? googleScriptURL_Java : googleScriptURL_Mobile;

            // Create FormData instead of JSON
            const formData = new FormData();
            formData.append("name", name);
            formData.append("track", track);
            formData.append("latitude", String(lat));
            formData.append("longitude", String(lon));
            formData.append("distance", String(distance.toFixed(2)));

            console.log("Sending data:", {name, track, lat, lon, distance: distance.toFixed(2)});

            fetch(webAppURL, {
              method: "POST",
              body: formData
            })
            .then(res => res.text())
            .then(resText => {
              console.log("Response:", resText);
              if (resText.includes("Duplicate")) {
                status.innerHTML += "<br><span style='color:orange;'>⚠ Already recorded today</span>";
              } else if (resText.includes("Success")) {
                status.innerHTML += "<br><span style='color:green;'>✅ Attendance recorded successfully</span>";
                document.getElementById("attendanceForm").reset();
              } else {
                status.innerHTML += "<br><span style='color:red;'>❌ Server response: " + resText + "</span>";
              }
            })
            .catch(err => {
              console.error("Fetch error:", err);
              status.innerHTML += "<br><span style='color:red;'>❌ Error sending data: " + err.message + "</span>";
            });

          } else {
            status.innerHTML += "<br><span style='color:red;'>❌ You are not at the authorized area</span>";
          }
        },
        () => {
          status.textContent = "Unable to retrieve your location.";
        },
        { enableHighAccuracy: true }
      );
    }
  </script>
</body>

</html>


